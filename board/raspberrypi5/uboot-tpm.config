# uboot-tpm.config — U-Boot config fragment for FoundationsOS RPi5
#
# Applied on top of rpi_arm64_defconfig via BR2_TARGET_UBOOT_CONFIG_FRAGMENT_FILES.
# Enables:
#   - FIT image boot (required by RAUC A/B verified boot)
#   - TPM2 SPI driver + TCG2 measured boot (PCR extend for kernel/DTB/cmdline)
#   - Environment stored in FAT (boot partition) for RAUC slot selection

# ─── FIT image & verified boot ────────────────────────────────────────────────
CONFIG_FIT=y
CONFIG_FIT_SIGNATURE=y
CONFIG_FIT_VERBOSE=y
CONFIG_LEGACY_IMAGE_FORMAT=y
CONFIG_BOOTSTD_DEFAULTS=y
CONFIG_BOOTSTD_FULL=y

# ─── Boot environment ─────────────────────────────────────────────────────────
# Store U-Boot environment in the FAT boot partition (mmcblk0p1).
CONFIG_ENV_IS_IN_FAT=y
CONFIG_ENV_FAT_INTERFACE="mmc"
CONFIG_ENV_FAT_DEVICE_AND_PART="0:1"
CONFIG_ENV_FAT_FILE="uboot.env"
CONFIG_ENV_SIZE=0x4000

# ─── RAUC boot selection variables ────────────────────────────────────────────
# RAUC uses "rauc.slot=a" / "rauc.slot=b" plus boot counters.
# The bootcount/bootlimit mechanism provides automatic rollback.
CONFIG_BOOTCOUNT_LIMIT=y
CONFIG_BOOTCOUNT_ENV=y
CONFIG_BOOTCOUNT_BOOTLIMIT=3

# ─── MMC / SD ─────────────────────────────────────────────────────────────────
CONFIG_MMC=y
CONFIG_MMC_SDHCI=y
CONFIG_MMC_SDHCI_BCM2835=y

# ─── SPI & TPM2 — Measured Boot (v0.3.0) ─────────────────────────────────────
# CONFIG_MEASURED_BOOT enables U-Boot's TCG2 measured boot subsystem.
# At boot, U-Boot extends TPM PCRs with hashes of each loaded component:
#   PCR[0]  — U-Boot itself (firmware measurement)
#   PCR[4]  — kernel Image, initramfs, FIT image data
#   PCR[5]  — U-Boot command-line / environment (kernel cmdline)
#   PCR[7]  — DTB (device tree blob)
# The measurements are recorded in a TCG2 event log accessible to Linux via
# /sys/kernel/security/tpm0/binary_bios_measurements (requires SECURITYFS).
CONFIG_SPI=y
CONFIG_DM_SPI=y
CONFIG_BCM2835_SPI=y
CONFIG_TPM=y
CONFIG_TPM_V2=y
CONFIG_TPM2_TIS_SPI=y
CONFIG_MEASURED_BOOT=y
CONFIG_MEASURE_DEVICETREE=y

# ─── Networking (TFTP boot for development) ───────────────────────────────────
CONFIG_NET=y
CONFIG_CMD_DHCP=y
CONFIG_CMD_TFTP=y

# ─── Useful commands ──────────────────────────────────────────────────────────
CONFIG_CMD_EXT4=y
CONFIG_CMD_FAT=y
CONFIG_CMD_FS_GENERIC=y
CONFIG_CMD_GPIO=y
CONFIG_CMD_I2C=n
CONFIG_CMD_MMC=y
CONFIG_CMD_SPI=y
CONFIG_CMD_TPM=y
CONFIG_CMD_TPM_V2=y

# ─── Security hardening ───────────────────────────────────────────────────────
# Disable features not needed in production to reduce attack surface.
CONFIG_CMD_SETEXPR=n
CONFIG_CMD_EDITENV=n
CONFIG_HUSH_PARSER=y
