# linux-hardened.config — Security hardening kernel config fragment for RPi3B+
#
# Applied on top of multi_v8_defconfig via BR2_LINUX_KERNEL_CONFIG_FRAGMENT_FILES.
# Identical security policy to the RPi5 fragment; platform-specific drivers differ.
#
# Reference: https://kernsec.org/wiki/index.php/Kernel_Self_Protection_Project

# ─── OP-TEE kernel driver ─────────────────────────────────────────────────────
# Required for tee-supplicant and libteec to communicate with OP-TEE OS (BL32).
# Creates /dev/tee0 (TA invocation) and /dev/teepriv0 (supplicant interface).
CONFIG_TEE=y
CONFIG_OPTEE=y

# ─── Security Filesystem (securityfs) ─────────────────────────────────────────
CONFIG_SECURITYFS=y

# ─── Integrity audit ─────────────────────────────────────────────────────────
CONFIG_INTEGRITY_AUDIT=y

# ─── TPM 2.0 & SPI ────────────────────────────────────────────────────────────
CONFIG_TCG_TPM=y
CONFIG_TCG_TIS=y
CONFIG_TCG_TIS_SPI=y
CONFIG_TCG_TIS_SPI_CR50=n
CONFIG_TCG_CRB=y
CONFIG_HW_RANDOM_TPM=y

# ─── IMA — Integrity Measurement Architecture ─────────────────────────────────
CONFIG_INTEGRITY=y
CONFIG_IMA=y
CONFIG_IMA_MEASURE_PCR_IDX=10
CONFIG_IMA_LSM_RULES=y
CONFIG_IMA_APPRAISE=y
CONFIG_IMA_APPRAISE_BOOTPARAM=y
CONFIG_IMA_APPRAISE_REQUIRE_FIRMWARE_SIGS=y
CONFIG_IMA_APPRAISE_REQUIRE_KEXEC_SIGS=y
CONFIG_IMA_APPRAISE_REQUIRE_MODULE_SIGS=y
CONFIG_IMA_TRUSTED_KEYRING=y
CONFIG_IMA_KEYRINGS_PERMIT_SIGNED_BY_BUILTIN_OR_SECONDARY=y
CONFIG_IMA_DEFAULT_HASH_SHA256=y
# v0.6.0: runtime policy update (used by ima-policy.service)
CONFIG_IMA_WRITE_POLICY=y
CONFIG_IMA_READ_POLICY=y

# ─── EVM — Extended Verification Module ───────────────────────────────────────
CONFIG_EVM=y
CONFIG_EVM_ATTR_FSUUID=y
CONFIG_EVM_EXTRA_SMACK_XATTRS=n
# v0.6.0: allow adding EVM xattrs at build-time signing
CONFIG_EVM_ADD_XATTRS=y

# ─── Asymmetric Key / Keyring Support ─────────────────────────────────────────
CONFIG_KEYS=y
CONFIG_TRUSTED_KEYS=y
CONFIG_ENCRYPTED_KEYS=y
CONFIG_KEY_DH_OPERATIONS=y
CONFIG_ASYMMETRIC_KEY_TYPE=y
CONFIG_ASYMMETRIC_PUBLIC_KEY_SUBTYPE=y
CONFIG_X509_CERTIFICATE_PARSER=y
CONFIG_PKCS7_MESSAGE_PARSER=y

# ─── AppArmor MAC ─────────────────────────────────────────────────────────────
CONFIG_SECURITY=y
CONFIG_SECURITY_APPARMOR=y
CONFIG_SECURITY_APPARMOR_BOOTPARAM_VALUE=1
CONFIG_DEFAULT_SECURITY_APPARMOR=y
CONFIG_LSM="lockdown,yama,loadpin,safesetid,integrity,apparmor,bpf"

# ─── Kernel Lockdown ──────────────────────────────────────────────────────────
CONFIG_SECURITY_LOCKDOWN_LSM=y
CONFIG_SECURITY_LOCKDOWN_LSM_EARLY=y
CONFIG_LOCK_DOWN_KERNEL_FORCE_NONE=y

# ─── Yama ─────────────────────────────────────────────────────────────────────
CONFIG_SECURITY_YAMA=y
CONFIG_SECURITY_YAMA_STACKED=y

# ─── dm-crypt / LUKS ──────────────────────────────────────────────────────────
CONFIG_BLK_DEV_DM=y
CONFIG_DM_CRYPT=y
CONFIG_DM_INTEGRITY=y
CONFIG_DM_VERITY=y
CONFIG_DM_VERITY_VERIFY_ROOTHASH_SIG=y
CONFIG_CRYPTO_XTS=y
CONFIG_CRYPTO_AES_ARM64=y
CONFIG_CRYPTO_SHA256=y
CONFIG_CRYPTO_SHA512=y

# ─── Seccomp ──────────────────────────────────────────────────────────────────
CONFIG_SECCOMP=y
CONFIG_SECCOMP_FILTER=y

# ─── Memory Protection ────────────────────────────────────────────────────────
CONFIG_STRICT_KERNEL_RWX=y
CONFIG_STRICT_MODULE_RWX=y
CONFIG_HARDENED_USERCOPY=y
CONFIG_HARDENED_USERCOPY_FALLBACK=n
CONFIG_FORTIFY_SOURCE=y
CONFIG_STACKPROTECTOR=y
CONFIG_STACKPROTECTOR_STRONG=y
# CONFIG_SHADOW_CALL_STACK is not enabled — requires SCS-capable toolchain (Clang)
CONFIG_RANDOMIZE_BASE=y
CONFIG_RANDOMIZE_MODULE_REGION_FULL=y

# ─── /proc restrictions ───────────────────────────────────────────────────────
CONFIG_SECURITY_DMESG_RESTRICT=y
CONFIG_PROC_KCORE=n

# ─── Kernel Module security ───────────────────────────────────────────────────
CONFIG_MODULES=y
CONFIG_MODVERSIONS=y
CONFIG_MODULE_SIG=y
# v0.6.0: enforce module signatures
CONFIG_MODULE_SIG_FORCE=y
CONFIG_MODULE_SIG_SHA256=y
# v0.6.0: sign all in-tree modules at build time
CONFIG_MODULE_SIG_ALL=y

# ─── Network ──────────────────────────────────────────────────────────────────
CONFIG_NET_INGRESS=y
CONFIG_NETFILTER=y
CONFIG_NF_TABLES=y
CONFIG_NFT_REJECT=y
CONFIG_NFT_LOG=y

# ─── Audit ────────────────────────────────────────────────────────────────────
CONFIG_AUDIT=y
CONFIG_AUDITSYSCALL=y

# ─── Disable dangerous features ───────────────────────────────────────────────
CONFIG_KEXEC=n
CONFIG_KEXEC_FILE=n
CONFIG_HIBERNATION=n
CONFIG_ACPI_CUSTOM_METHOD=n
CONFIG_BINFMT_MISC=n
CONFIG_LEGACY_PTYS=n

# ─── RPi3B+ / BCM2837 platform specifics ─────────────────────────────────────
CONFIG_ARCH_BCM=y
CONFIG_ARCH_BCM2835=y
CONFIG_RASPBERRYPI_FIRMWARE=y
CONFIG_RASPBERRYPI_POWER=y
CONFIG_CLK_RASPBERRYPI=y
CONFIG_SPI=y
CONFIG_SPI_BCM2835=y
CONFIG_SPI_SPIDEV=y
CONFIG_MMC=y
CONFIG_MMC_BCM2835=y
CONFIG_USB_DWC2=y
# Bluetooth disabled — using UART0 for system console
CONFIG_BT=n

# ─── Debug (disabled for production) ─────────────────────────────────────────
CONFIG_DEBUG_KERNEL=n
CONFIG_DEBUG_INFO=n
CONFIG_KPROBES=n
CONFIG_FTRACE=n
