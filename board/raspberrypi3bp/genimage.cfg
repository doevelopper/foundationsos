# genimage.cfg — Disk image layout for Raspberry Pi 3 Model B+
#
# Uses GPT (supported by RPi firmware >= 2022-04).
# For maximum compatibility with older firmware, MBR can be used instead —
# replace "gpt = true" with "partition-table-type = msdos".
#
# Partition layout (A/B for RAUC):
#   p1  boot      FAT32  128 MiB   — Firmware, DTBs, TF-A (bl31.bin), OP-TEE, U-Boot
#   p2  rootfs_a  ext4   512 MiB   — Active root filesystem (RAUC slot A)
#   p3  rootfs_b  ext4   512 MiB   — Redundant root filesystem (RAUC slot B)
#   p4  data      ext4   128 MiB   — Persistent data (config, logs)
#
# Total minimum SD card size: ~1.3 GiB (use ≥ 4 GiB for headroom)

image boot.vfat {
    vfat {
        files = {
            "bcm2837-rpi-3-b-plus.dtb",
            "Image",
            "config.txt",
            "cmdline.txt",
            "boot.scr",
            "start.elf",
            "fixup.dat",
            "bootcode.bin",
            "u-boot.bin",
        }
    }
    size = 128M
}

image rootfs_a.ext4 {
    ext4 {
        label = "rootfs_a"
    }
    size = 512M
}

image rootfs_b.ext4 {
    ext4 {
        label = "rootfs_b"
    }
    size = 512M
}

image data.ext4 {
    ext4 {
        label = "data"
    }
    size = 128M
}

image sdcard.img {
    hdimage {
        gpt = true
    }

    partition boot {
        partition-type-uuid = "c12a7328-f81f-11d2-ba4b-00a0c93ec93b"
        image = "boot.vfat"
        offset = 8M
        size   = 128M
        bootable = true
    }

    partition rootfs_a {
        partition-type-uuid = "0fc63daf-8483-4772-8e79-3d69d8477de4"
        image = "rootfs_a.ext4"
    }

    partition rootfs_b {
        partition-type-uuid = "0fc63daf-8483-4772-8e79-3d69d8477de4"
        image = "rootfs_b.ext4"
    }

    partition data {
        partition-type-uuid = "0fc63daf-8483-4772-8e79-3d69d8477de4"
        image = "data.ext4"
    }
}
