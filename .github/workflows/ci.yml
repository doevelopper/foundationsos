name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Static Analysis
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: 'warning'
          additional_files: >-
            board/raspberrypi5/post-build.sh
            board/raspberrypi5/post-image.sh
            board/raspberrypi3bp/post-build.sh
            board/raspberrypi3bp/post-image.sh

      - name: Check defconfig syntax (RPi5)
        run: |
          python3 scripts/check_defconfig.py configs/raspberrypi5_defconfig

      - name: Check defconfig syntax (RPi3B+)
        run: |
          python3 scripts/check_defconfig.py configs/raspberrypi3bp_defconfig

      - name: Validate RAUC system.conf (RPi5)
        run: |
          if command -v rauc &>/dev/null; then
            rauc --conf=board/raspberrypi5/rootfs_overlay/etc/rauc/system.conf info || true
          else
            echo "rauc not installed on runner, skipping config validation"
          fi

      - name: Validate RAUC system.conf (RPi3B+)
        run: |
          if command -v rauc &>/dev/null; then
            rauc --conf=board/raspberrypi3bp/rootfs_overlay/etc/rauc/system.conf info || true
          else
            echo "rauc not installed on runner, skipping config validation"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-22.04
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Secret scanning (detect-secrets)
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline || true

  defconfig-check:
    name: Defconfig Consistency Check
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Buildroot dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y build-essential bc libncurses-dev

      - name: Download Buildroot
        run: |
          BUILDROOT_VERSION=2024.02
          wget -q https://buildroot.org/downloads/buildroot-${BUILDROOT_VERSION}.tar.gz
          tar -xzf buildroot-${BUILDROOT_VERSION}.tar.gz
          mv buildroot-${BUILDROOT_VERSION} buildroot

      - name: Check RPi5 defconfig applies cleanly
        run: |
          make -C buildroot O=/tmp/br-rpi5 BR2_EXTERNAL=$PWD/external \
            DEFCONFIG=$PWD/configs/raspberrypi5_defconfig defconfig
          echo "RPi5 defconfig applied successfully"

      - name: Check RPi3B+ defconfig applies cleanly
        run: |
          make -C buildroot O=/tmp/br-rpi3bp BR2_EXTERNAL=$PWD/external \
            DEFCONFIG=$PWD/configs/raspberrypi3bp_defconfig defconfig
          echo "RPi3B+ defconfig applied successfully"

  rauc-validation:
    name: RAUC Configuration Validation
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y openssl shellcheck || true

      - name: Validate RAUC system.conf — RPi5
        run: |
          grep -q "compatible=foundationsos-rpi5" board/raspberrypi5/rootfs_overlay/etc/rauc/system.conf
          grep -q "bootloader=uboot" board/raspberrypi5/rootfs_overlay/etc/rauc/system.conf
          grep -q "bundle-formats=verity" board/raspberrypi5/rootfs_overlay/etc/rauc/system.conf
          grep -q "statusfile=" board/raspberrypi5/rootfs_overlay/etc/rauc/system.conf
          grep -q "max-bundle-download-size=" board/raspberrypi5/rootfs_overlay/etc/rauc/system.conf
          echo "RPi5 system.conf OK"

      - name: Validate RAUC system.conf — RPi3B+
        run: |
          grep -q "compatible=foundationsos-rpi3bp" board/raspberrypi3bp/rootfs_overlay/etc/rauc/system.conf
          grep -q "bootloader=uboot" board/raspberrypi3bp/rootfs_overlay/etc/rauc/system.conf
          grep -q "bundle-formats=verity" board/raspberrypi3bp/rootfs_overlay/etc/rauc/system.conf
          grep -q "statusfile=" board/raspberrypi3bp/rootfs_overlay/etc/rauc/system.conf
          grep -q "max-bundle-download-size=" board/raspberrypi3bp/rootfs_overlay/etc/rauc/system.conf
          echo "RPi3B+ system.conf OK"

      - name: Validate hawkbit.conf templates
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            CONF="board/${board}/rootfs_overlay/etc/rauc/hawkbit.conf"
            test -f "${CONF}" || (echo "MISSING: ${CONF}" && exit 1)
            grep -q "hawkbit_server" "${CONF}"
            grep -q "ssl.*=.*true" "${CONF}"
            echo "${board}/hawkbit.conf OK"
          done

      - name: Validate rauc-mark-good and rauc-hawkbit-updater services
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            for svc in rauc-mark-good rauc-hawkbit-updater; do
              F="board/${board}/rootfs_overlay/etc/systemd/system/${svc}.service"
              test -f "${F}" || (echo "MISSING: ${F}" && exit 1)
              echo "${board}/${svc}.service OK"
            done
          done

      - name: Run RAUC smoke test
        run: |
          chmod +x scripts/test-rauc-bundle.sh scripts/build-rauc-bundle.sh
          bash scripts/test-rauc-bundle.sh --smoke-test

      - name: ShellCheck RAUC scripts
        run: |
          shellcheck scripts/build-rauc-bundle.sh scripts/test-rauc-bundle.sh

  luks-validation:
    name: LUKS Configuration Validation
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck || true

      - name: Validate crypttab files
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            F="board/${board}/rootfs_overlay/etc/crypttab"
            test -f "${F}" || (echo "MISSING: ${F}" && exit 1)
            echo "${board}/crypttab present"
          done

      - name: Validate LUKS systemd services
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            for svc in luks-data.service data.mount; do
              F="board/${board}/rootfs_overlay/etc/systemd/system/${svc}"
              test -f "${F}" || (echo "MISSING: ${F}" && exit 1)
              echo "${board}/${svc} present"
            done
            # Check luks-data.service ordering
            grep -q "Before=data.mount" "board/${board}/rootfs_overlay/etc/systemd/system/luks-data.service"
            grep -q "tpm2-abrmd.service" "board/${board}/rootfs_overlay/etc/systemd/system/luks-data.service"
            # Check data.mount requires luks-data
            grep -q "Requires=luks-data.service" "board/${board}/rootfs_overlay/etc/systemd/system/data.mount"
            echo "${board}: service ordering OK"
          done

      - name: Validate LUKS scripts exist and have correct syntax
        run: |
          test -f scripts/luks-init.sh     || (echo "MISSING: scripts/luks-init.sh" && exit 1)
          test -f scripts/luks-tpm-seal.sh || (echo "MISSING: scripts/luks-tpm-seal.sh" && exit 1)
          bash -n scripts/luks-init.sh
          bash -n scripts/luks-tpm-seal.sh
          echo "luks-init.sh and luks-tpm-seal.sh syntax OK"

      - name: ShellCheck LUKS scripts
        run: |
          shellcheck scripts/luks-init.sh scripts/luks-tpm-seal.sh

      - name: Validate post-build.sh installs LUKS scripts
        run: |
          grep -q "luks-init.sh" board/raspberrypi5/post-build.sh
          grep -q "luks-tpm-seal.sh" board/raspberrypi5/post-build.sh
          grep -q "mkdir.*data" board/raspberrypi5/post-build.sh
          grep -q "luks-init.sh" board/raspberrypi3bp/post-build.sh
          echo "post-build.sh LUKS entries OK"

      - name: Validate kernel fragments include LUKS ciphers
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            FRAG="board/${board}/linux-hardened.config"
            grep -q "CONFIG_DM_CRYPT=y" "${FRAG}"
            grep -q "CONFIG_CRYPTO_XTS=y" "${FRAG}"
            grep -q "CONFIG_CRYPTO_AES_ARM64=y" "${FRAG}"
            echo "${board}/linux-hardened.config LUKS cipher options OK"
          done

      - name: Validate ADR-0009 exists
        run: test -f docs/adr/0009-luks-tpm-sealed-key.md

  ima-evm-validation:
    name: IMA/EVM Validation
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Validate IMA scripts exist and have correct syntax
        run: |
          for s in scripts/generate-ima-keys.sh scripts/ima-sign-rootfs.sh scripts/evm-setup.sh; do
            test -f "${s}" || (echo "MISSING: ${s}" && exit 1)
            bash -n "${s}" && echo "${s}: syntax OK"
          done

      - name: ShellCheck IMA/EVM scripts
        run: |
          sudo apt-get install -y shellcheck -qq
          shellcheck scripts/generate-ima-keys.sh \
                     scripts/ima-sign-rootfs.sh \
                     scripts/evm-setup.sh

      - name: Validate ima-policy.service and evm-setup.service for both boards
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            for svc in ima-policy.service evm-setup.service; do
              F="board/${board}/rootfs_overlay/etc/systemd/system/${svc}"
              test -f "${F}" || (echo "MISSING: ${F}" && exit 1)
              echo "${board}/${svc}: present"
            done
            # ima-policy must load before sysinit
            grep -q "Before=sysinit.target" \
              "board/${board}/rootfs_overlay/etc/systemd/system/ima-policy.service"
            # evm-setup must depend on tpm2-abrmd
            grep -q "Requires=tpm2-abrmd.service" \
              "board/${board}/rootfs_overlay/etc/systemd/system/evm-setup.service"
            # evm-setup must run after ima-policy
            grep -q "After=ima-policy.service" \
              "board/${board}/rootfs_overlay/etc/systemd/system/evm-setup.service"
            echo "${board}: service ordering OK"
          done

      - name: Validate IMA policy files for full enforcement
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            POLICY="board/${board}/rootfs_overlay/etc/ima/ima-policy"
            test -f "${POLICY}" || (echo "MISSING: ${POLICY}" && exit 1)
            grep -q "appraise_type=imasig" "${POLICY}" || \
              (echo "IMA policy missing imasig enforcement in ${POLICY}" && exit 1)
            grep -q "func=MODULE_CHECK" "${POLICY}" || \
              (echo "IMA policy missing MODULE_CHECK in ${POLICY}" && exit 1)
            grep -q "func=FIRMWARE_CHECK" "${POLICY}" || \
              (echo "IMA policy missing FIRMWARE_CHECK in ${POLICY}" && exit 1)
            echo "${board}/ima-policy: enforcement rules OK"
          done

      - name: Validate kernel config fragments include IMA enforcement options
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            FRAG="board/${board}/linux-hardened.config"
            for opt in \
              CONFIG_IMA_APPRAISE_REQUIRE_FIRMWARE_SIGS \
              CONFIG_IMA_APPRAISE_REQUIRE_MODULE_SIGS \
              CONFIG_IMA_WRITE_POLICY \
              CONFIG_IMA_READ_POLICY \
              CONFIG_EVM_ADD_XATTRS \
              CONFIG_MODULE_SIG_FORCE; do
              grep -q "${opt}=y" "${FRAG}" || \
                (echo "MISSING ${opt} in ${FRAG}" && exit 1)
            done
            echo "${board}/linux-hardened.config: IMA/EVM kernel options OK"
          done

      - name: Validate post-build.sh installs evm-setup.sh and calls IMA signer
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            PB="board/${board}/post-build.sh"
            grep -q "evm-setup.sh" "${PB}" || \
              (echo "MISSING evm-setup.sh install in ${PB}" && exit 1)
            grep -q "ima-sign-rootfs.sh" "${PB}" || \
              (echo "MISSING ima-sign-rootfs call in ${PB}" && exit 1)
            echo "${board}/post-build.sh: IMA/EVM entries OK"
          done

      - name: Validate ADR-0010 exists
        run: test -f docs/adr/0010-ima-evm-full-enforcement.md

  apparmor-validation:
    name: AppArmor Validation
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install apparmor_parser
        run: sudo apt-get install -y apparmor -qq

      - name: Validate profile files present for both boards
        run: |
          EXPECTED_PROFILES=(
            usr.sbin.tee-supplicant
            usr.sbin.tpm2-abrmd
            usr.bin.rauc
            usr.bin.rauc-hawkbit-updater
            usr.sbin.sshd
            lib.systemd.systemd-networkd
            lib.systemd.systemd-resolved
            usr.sbin.luks-init
            usr.sbin.evm-setup
          )
          for board in raspberrypi5 raspberrypi3bp; do
            AADIR="board/${board}/rootfs_overlay/etc/apparmor.d"
            for p in "${EXPECTED_PROFILES[@]}"; do
              test -f "${AADIR}/${p}" || \
                (echo "MISSING: ${AADIR}/${p}" && exit 1)
            done
            echo "${board}: all expected profiles present"
          done

      - name: Parse all AppArmor profiles (syntax check)
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            AADIR="board/${board}/rootfs_overlay/etc/apparmor.d"
            ERRORS=0
            for f in "${AADIR}"/*; do
              [[ -f "${f}" ]] || continue
              apparmor_parser --base /etc/apparmor.d --include /etc/apparmor.d --parse "${f}" || { echo "PARSE FAIL: ${f}"; ERRORS=$((ERRORS+1)); }
            done
            [[ ${ERRORS} -eq 0 ]] || (echo "${board}: ${ERRORS} profile parse error(s)" && exit 1)
            echo "${board}: all profiles parse OK"
          done

      - name: Validate apparmor-load.service for both boards
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            SVC="board/${board}/rootfs_overlay/etc/systemd/system/apparmor-load.service"
            test -f "${SVC}" || (echo "MISSING: ${SVC}" && exit 1)
            grep -q "Before=sysinit.target" "${SVC}" || \
              (echo "Missing Before=sysinit.target in ${SVC}" && exit 1)
            grep -q "apparmor_parser" "${SVC}" || \
              (echo "Missing apparmor_parser call in ${SVC}" && exit 1)
            echo "${board}/apparmor-load.service: OK"
          done

      - name: Validate apparmor-check.sh syntax
        run: |
          test -f scripts/apparmor-check.sh || (echo "MISSING: scripts/apparmor-check.sh" && exit 1)
          bash -n scripts/apparmor-check.sh
          shellcheck scripts/apparmor-check.sh
          echo "scripts/apparmor-check.sh: syntax OK"

      - name: Validate profiles enforce deny rules for sensitive paths
        run: |
          for board in raspberrypi5 raspberrypi3bp; do
            AADIR="board/${board}/rootfs_overlay/etc/apparmor.d"
            # tpm2-abrmd must not allow /etc/tpm2/ (sealed key blobs)
            grep -q "deny /etc/tpm2/" "${AADIR}/usr.sbin.tpm2-abrmd" || \
              (echo "tpm2-abrmd missing deny /etc/tpm2/" && exit 1)
            # sshd must deny TPM access
            grep -q "deny /dev/tpm" "${AADIR}/usr.sbin.sshd" || \
              (echo "sshd missing deny /dev/tpm*" && exit 1)
            # rauc-hawkbit-updater must deny TPM
            grep -q "deny /dev/tpm" "${AADIR}/usr.bin.rauc-hawkbit-updater" || \
              (echo "rauc-hawkbit-updater missing deny /dev/tpm*" && exit 1)
            # tee-supplicant must deny network
            grep -q "deny network inet" "${AADIR}/usr.sbin.tee-supplicant" || \
              (echo "tee-supplicant missing deny network" && exit 1)
            echo "${board}: sensitive path deny rules OK"
          done

      - name: Validate BR2_PACKAGE_APPARMOR in both defconfigs
        run: |
          grep -q "BR2_PACKAGE_APPARMOR=y" configs/raspberrypi5_defconfig || \
            (echo "Missing BR2_PACKAGE_APPARMOR=y in raspberrypi5_defconfig" && exit 1)
          grep -q "BR2_PACKAGE_APPARMOR=y" configs/raspberrypi3bp_defconfig || \
            (echo "Missing BR2_PACKAGE_APPARMOR=y in raspberrypi3bp_defconfig" && exit 1)
          echo "defconfigs: BR2_PACKAGE_APPARMOR=y present"

      - name: Validate ADR-0011 exists
        run: test -f docs/adr/0011-apparmor-mac-profiles.md

  docs:
    name: Documentation Check
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Check for broken Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/mlc_config.json'
