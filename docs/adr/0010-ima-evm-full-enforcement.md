# ADR-0010: IMA/EVM Full Enforcement with Build-Time Signed File Hashes

| Field       | Value                      |
|-------------|----------------------------|
| Status      | Accepted                   |
| Date        | 2026-02-28                 |
| Milestone   | v0.6.0                     |
| Supersedes  | —                          |
| Authors     | FoundationsOS Contributors |

---

## Context

Prior milestones established a TPM-measured boot chain (PCR[0,4,7,8]), a
sealed LUKS key for the data partition, and an IMA measurement policy that
collected hashes into the IMA log but did **not** enforce file integrity
(appraisal was present in policy but files lacked `security.ima` xattrs).

The threat model requires that:
- Any tampering with root-filesystem executables, shared libraries, kernel
  modules, or firmware between image signing and execution is detected and
  the execution **denied**.
- The integrity evidence is verifiable from the IMA measurement log without
  requiring physical access to the device.
- The EVM HMAC protects the full set of security-relevant extended attributes
  (`security.ima`, `security.selinux`, `security.apparmor`, `user.*`) so that
  an attacker with root access cannot silently replace an `security.ima` xattr.

---

## Decision

### IMA — Integrity Measurement Architecture (full enforcement)

**Algorithm:** RSA-4096 / SHA-256 (`ima-sig` template)

**Signing key hierarchy:**

```
RSA-4096 IMA Signing Key (keys/ima/ima-signing-key.pem)
  └── X.509 Certificate (keys/ima/ima-signing-cert.der)
        └── Embedded in kernel .ima_digsig built-in keyring
              └── Verifies security.ima xattr on each file exec/mmap
```

**Build-time signing flow:**

```
Buildroot post-build.sh
  └── scripts/ima-sign-rootfs.sh <TARGET_DIR>
        ├── evmctl ima_sign --key ima-signing-key.pem --hashalgo sha256
        │     applied to: ELF executables, shared objects (.so*), kernel
        │     modules (.ko) owned by root in /bin /sbin /usr/bin /usr/sbin
        │     /lib /usr/lib /lib/modules
        └── Writes RSA signature to security.ima xattr on each file
```

**Runtime enforcement:**

The `ima-policy.service` unit (Before=sysinit.target) writes
`/etc/ima/ima-policy` to `/sys/kernel/security/ima/policy` before any
user-space process is started. The policy enforces:

```
appraise func=BPRM_CHECK  appraise_type=imasig|meta_immutable fowner=0
appraise func=FILE_MMAP   appraise_type=imasig|meta_immutable fowner=0
appraise func=MODULE_CHECK appraise_type=imasig|meta_immutable
appraise func=FIRMWARE_CHECK appraise_type=imasig|meta_immutable
appraise func=POLICY_CHECK appraise_type=imasig|meta_immutable
```

Any root-owned executable missing or carrying an invalid `security.ima`
signature will be **denied** (`-EACCES`).

**Kernel module signing:**

`CONFIG_MODULE_SIG_FORCE=y` and `CONFIG_MODULE_SIG_ALL=y` are set so that
all in-tree kernel modules are signed at kernel build time with the kernel's
own ephemeral module signing key and only signed modules may be loaded.

### EVM — Extended Verification Module

**Mode at v0.6.0:** `2` (digital signatures only — read-only protection)
Upgraded to mode `6` (HMAC + signatures) at v1.0.0 after all files have
EVM xattrs.

**HMAC key management:**

```
Factory provisioning (scripts/evm-setup.sh --provision):
  1. 32-byte random key generated by scripts/generate-ima-keys.sh
  2. Sealed to TPM under SRK (0x81000001) with PCR[0,4,7,8] policy
     → /etc/tpm2/evm-hmac.{pub,priv}

Runtime boot (evm-setup.service, Before=sysinit.target):
  1. Unseal EVM HMAC key from TPM (PCR policy must match)
  2. keyctl add user evm-key <raw-bytes> @s  → loads into _evm keyring
  3. echo 2 > /sys/kernel/security/evm      → activate EVM mode 2
  4. shred /run/evm/evm-hmac.key            → destroy runtime copy
```

**Service ordering:**

```
sysinit.target
  ↑ Requires/After
ima-policy.service   (loads IMA appraisal policy)
  ↑ Before
evm-setup.service    (unseals EVM key, activates EVM)
  ↑ Requires
tpm2-abrmd.service   (TPM resource manager)
```

---

## Alternatives Considered

| Alternative | Reason Rejected |
|---|---|
| IMA in `fix` mode permanently | Does not provide integrity enforcement; only generates hashes for new files |
| dm-verity for rootfs instead of IMA | dm-verity requires a read-only rootfs; FoundationsOS uses read-write rootfs with selective signing |
| EVM mode 6 (HMAC) from v0.6.0 | Requires all security xattrs pre-populated; risk of boot failure if any file is missed. Deferred to v1.0.0 |
| Signing key in TPM (TPM2 signing) | evmctl does not natively support TPM-backed signing; HSM integration is a future milestone |
| IMA with SHA-512 | SHA-256 provides sufficient collision resistance; SHA-512 has higher per-file overhead in IMA log |

---

## Key File Locations

| File | Location | Permissions |
|---|---|---|
| IMA signing private key | `keys/ima/ima-signing-key.pem` | 600 (build machine only, NEVER in image) |
| IMA X.509 certificate (PEM) | `keys/ima/ima-signing-cert.pem` | 644 |
| IMA X.509 certificate (DER) | `keys/ima/ima-signing-cert.der` | 644 (embed in kernel) |
| EVM HMAC key (raw, build-time) | `keys/ima/evm-hmac.key` | 600 (build machine only) |
| EVM HMAC sealed public blob | `/etc/tpm2/evm-hmac.pub` | 400 (in rootfs) |
| EVM HMAC sealed private blob | `/etc/tpm2/evm-hmac.priv` | 400 (in rootfs) |

---

## Security Considerations

1. **Private key compromise:** If `keys/ima/ima-signing-key.pem` is
   compromised, an attacker can sign arbitrary executables and bypass IMA.
   In production, the key must be stored in an HSM or air-gapped system.
   Key rotation requires rebuilding the image with a new certificate compiled
   into the kernel keyring.

2. **PCR binding for EVM:** The EVM HMAC key is sealed under PCR[0,4,7,8].
   A firmware update changes PCR[0,4] and breaks the seal. A re-provisioning
   step is required after every firmware or bootloader OTA update
   (future v0.6.1 RAUC post-install hook).

3. **IMA log attestation:** The measurement list in PCR[10] can be remotely
   attested via the AIK (0x81000002) established in v0.3.0. A remote verifier
   can replay the log and verify every executed binary matches the known-good
   hash signed at build time.

4. **RAUC OTA and IMA:** RAUC writes to the inactive rootfs slot. After slot
   activation the new rootfs must have all binaries pre-signed with the IMA
   key. The RAUC bundle generator (`scripts/build-rauc-bundle.sh`) must call
   `ima-sign-rootfs.sh` before packing the bundle.

---

## References

- [Linux IMA project](https://sourceforge.net/p/linux-ima/wiki/Home/)
- [EVM documentation](https://www.kernel.org/doc/html/latest/security/IMA-templates.html)
- [ima-evm-utils / evmctl](https://github.com/linux-integrity/ima-evm-utils)
- ADR-0007: TPM Measured Boot
- ADR-0009: LUKS2 TPM-sealed key
